---
# roles/satellite_sync_plan_weekly_enforcement/tasks/main.yml
#
# Main entry point for the satellite_sync_plan_weekly_enforcement role.
# This file orchestrates two separate concerns:
#   A. Enforcement - correct non-weekly sync plan intervals (respects opt-out)
#   B. Sync status - collect product sync health from ALL organizations (no opt-out)
#
# Workflow:
#   1. Initialize tracking variables for reports
#   2. Retrieve all organizations from Satellite
#   3. Filter out opted-out organizations (for enforcement only)
#   4. Loop through filtered orgs - enforce weekly intervals
#   5. Loop through ALL orgs - collect product sync status
#   6. Generate and display compliance report
#   7. Generate and display product sync status report
#   8. Send email notification if any sync failures are detected

# -----------------------------------------------------------------------------
# Initialize tracking variables
# -----------------------------------------------------------------------------
# These lists track enforcement results and sync status across all organizations.
- name: Initialize compliance tracking variables
  ansible.builtin.set_fact:
    corrected_organizations: []
    compliant_organizations: []
    enforcement_details: []
    sync_status_details: []

# -----------------------------------------------------------------------------
# Retrieve all organizations from Satellite
# -----------------------------------------------------------------------------
# Uses the redhat.satellite.organization_info module to get all orgs.
- name: Get all organizations from Satellite
  redhat.satellite.organization_info:
    server_url: "{{ satellite_server_url }}"
    username: "{{ satellite_setup_username }}"
    password: "{{ satellite_initial_admin_password }}"
    validate_certs: true
  register: all_organizations

- name: Display retrieved organizations
  ansible.builtin.debug:
    msg: "Found {{ all_organizations.organizations | length }} organization(s) in Satellite"

# -----------------------------------------------------------------------------
# Filter out opted-out organizations (for enforcement only)
# -----------------------------------------------------------------------------
# This filtered list is ONLY used for enforcement.
# Sync status collection uses the unfiltered all_organizations list.
- name: Build list of organizations to process (excluding opt-outs)
  ansible.builtin.set_fact:
    organizations_to_process: >-
      {{
        all_organizations.organizations
        | rejectattr('name', 'in', sync_plan_enforcement_org_opt_out)
        | list
      }}

- name: Display organizations to be processed
  ansible.builtin.debug:
    msg: >-
      Enforcing on {{ organizations_to_process | length }} organization(s).
      Opted-out of enforcement: {{ sync_plan_enforcement_org_opt_out | default([]) | join(', ') | default('none', true) }}.
      Collecting sync status from ALL {{ all_organizations.organizations | length }} organization(s).

# =============================================================================
# A. ENFORCEMENT - Runs on filtered organizations only (respects opt-out)
# =============================================================================
- name: Process sync plan enforcement for each organization (opt-out respected)
  ansible.builtin.include_tasks: process_organization.yml
  loop: "{{ organizations_to_process }}"
  loop_control:
    loop_var: current_org
    label: "{{ current_org.name }}"

# =============================================================================
# B. SYNC STATUS - Runs on ALL organizations (opt-out ignored)
# =============================================================================
- name: Collect sync status from ALL organizations (opt-out ignored)
  ansible.builtin.include_tasks: collect_sync_status.yml
  loop: "{{ all_organizations.organizations }}"
  loop_control:
    loop_var: current_org
    label: "{{ current_org.name }}"

# =============================================================================
# Compliance Report
# =============================================================================
- name: Display compliance report header
  ansible.builtin.debug:
    msg: |

      ============================================================
      Weekly Sync Plan Interval Compliance Report
      ============================================================

- name: Display corrected organizations
  ansible.builtin.debug:
    msg: |
      Corrected Organizations (interval changed to weekly):
      {% if corrected_organizations | length > 0 %}
      {% for org in corrected_organizations %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display compliant organizations
  ansible.builtin.debug:
    msg: |
      Compliant Organizations (no changes required):
      {% if compliant_organizations | length > 0 %}
      {% for org in compliant_organizations %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display opted-out organizations
  ansible.builtin.debug:
    msg: |
      Opted-Out Organizations (enforcement skipped, sync status still checked):
      {% if sync_plan_enforcement_org_opt_out | length > 0 %}
      {% for org in sync_plan_enforcement_org_opt_out %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display enforcement details
  ansible.builtin.debug:
    msg: |

      Enforcement Details:
      {% if enforcement_details | length > 0 %}
      {% for detail in enforcement_details %}
        - Org: {{ detail.organization }}, Plan: {{ detail.sync_plan }}, Was: {{ detail.old_interval }}, Now: weekly
      {% endfor %}
      {% else %}
        No changes were made.
      {% endif %}

      ============================================================
      End of Compliance Report
      ============================================================

# =============================================================================
# Product Sync Status Report
# =============================================================================

# -----------------------------------------------------------------------------
# Identify sync failures - anything where sync_state != "Syncing Complete."
# -----------------------------------------------------------------------------
- name: Identify sync failures across all organizations
  ansible.builtin.set_fact:
    sync_failures: >-
      {{
        sync_status_details
        | rejectattr('sync_state', 'equalto', 'Syncing Complete.')
        | list
      }}

- name: Display product sync status report header
  ansible.builtin.debug:
    msg: |

      ============================================================
      Product Sync Status Report (ALL Organizations)
      ============================================================

# -----------------------------------------------------------------------------
# Display full sync status grouped by organization and sync plan
# Products with sync failures are flagged with *** SYNC FAILURE ***
# -----------------------------------------------------------------------------
- name: Display product sync status report
  ansible.builtin.debug:
    msg: |
      {% set ns = namespace(current_org='', current_plan='') %}
      {% for entry in sync_status_details %}
      {% if entry.organization != ns.current_org %}
      {% set ns.current_org = entry.organization %}
      Organization: {{ entry.organization }}
      {% endif %}
      {% if entry.sync_plan != ns.current_plan %}
      {% set ns.current_plan = entry.sync_plan %}
        Sync Plan: {{ entry.sync_plan }}
      {% endif %}
      {% if entry.sync_state != 'Syncing Complete.' %}
          *** SYNC FAILURE *** {{ entry.product_name }} | {{ entry.sync_state }} | {{ entry.last_sync }}
      {% else %}
          - {{ entry.product_name }} | {{ entry.sync_state }} | {{ entry.last_sync }}
      {% endif %}
      {% endfor %}
      {% if sync_status_details | length == 0 %}
        No sync plans with products found.
      {% endif %}

# -----------------------------------------------------------------------------
# Summary line - quick glance at overall health
# -----------------------------------------------------------------------------
- name: Display sync status summary
  ansible.builtin.debug:
    msg: |

      Summary: {{ sync_status_details | length }} product(s) checked across ALL organizations, {{ sync_failures | length }} failure(s) detected.

      ============================================================
      End of Product Sync Status Report
      ============================================================

# =============================================================================
# Email notification on sync failure
# =============================================================================
# Only fires if there are failures. No failures = no email = no noise.
# Uses community.general.mail module for SMTP delivery.
# -----------------------------------------------------------------------------
- name: Send sync failure email notification
  community.general.mail:
    host: "{{ smtp_host }}"
    port: "{{ smtp_port }}"
    secure: "{{ smtp_secure }}"
    username: "{{ smtp_username | default(omit) }}"
    password: "{{ smtp_password | default(omit) }}"
    from: "{{ sync_failure_email_from }}"
    to: "{{ sync_failure_email_to }}"
    subject: "ALERT - Satellite Sync Failure Detected - {{ sync_failures | length }} product(s) affected"
    body: |
      ============================================================
      Satellite Sync Failure Report
      ============================================================

      {{ sync_failures | length }} product(s) with incomplete or failed sync detected.

      Failures:
      {% for failure in sync_failures %}
        *** SYNC FAILURE ***
          Organization: {{ failure.organization }}
          Sync Plan:    {{ failure.sync_plan }}
          Product:      {{ failure.product_name }}
          Sync State:   {{ failure.sync_state }}
          Last Sync:    {{ failure.last_sync }}

      {% endfor %}
      ============================================================
      End of Satellite Sync Failure Report
      ============================================================

      This is an automated notification from the
      satellite_sync_plan_weekly_enforcement role.
  delegate_to: localhost
  when: sync_failures | length > 0

- name: Confirm no sync failure email needed
  ansible.builtin.debug:
    msg: "All products report 'Syncing Complete.' - no failure email sent."
  when: sync_failures | length == 0
