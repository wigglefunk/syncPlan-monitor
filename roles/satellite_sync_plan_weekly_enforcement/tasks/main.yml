---
# roles/satellite_sync_plan_weekly_enforcement/tasks/main.yml
#
# Main entry point for the satellite_sync_plan_weekly_enforcement role.
# This file orchestrates the enforcement of weekly sync plan intervals.
#
# Workflow:
#   1. Initialize tracking variables for the compliance report
#   2. Retrieve all organizations from Satellite
#   3. Filter out opted-out organizations
#   4. Loop through each organization and process its sync plans
#   5. Generate and display the compliance report

# -----------------------------------------------------------------------------
# Initialize tracking variables
# -----------------------------------------------------------------------------
# These lists track which organizations were corrected vs already compliant.
# Used later to generate the compliance report.
- name: Initialize compliance tracking variables
  ansible.builtin.set_fact:
    corrected_organizations: []
    compliant_organizations: []
    enforcement_details: []

# -----------------------------------------------------------------------------
# Retrieve all organizations from Satellite
# -----------------------------------------------------------------------------
# Uses the redhat.satellite.organization_info module to get all orgs.
- name: Get all organizations from Satellite
  redhat.satellite.organization_info:
    server_url: "{{ satellite_server_url }}"
    username: "{{ satellite_setup_username }}"
    password: "{{ satellite_initial_admin_password }}"
    validate_certs: true
  register: all_organizations

- name: Display retrieved organizations
  ansible.builtin.debug:
    msg: "Found {{ all_organizations.organizations | length }} organization(s) in Satellite"

# -----------------------------------------------------------------------------
# Filter out opted-out organizations
# -----------------------------------------------------------------------------
# Remove any organizations listed in sync_plan_enforcement_org_opt_out.
- name: Build list of organizations to process (excluding opt-outs)
  ansible.builtin.set_fact:
    organizations_to_process: >-
      {{
        all_organizations.organizations
        | rejectattr('name', 'in', sync_plan_enforcement_org_opt_out)
        | list
      }}

- name: Display organizations to be processed
  ansible.builtin.debug:
    msg: >-
      Processing {{ organizations_to_process | length }} organization(s).
      Opted-out: {{ sync_plan_enforcement_org_opt_out | default([]) | join(', ') | default('none', true) }}

# -----------------------------------------------------------------------------
# Process each organization
# -----------------------------------------------------------------------------
# Loop through each organization and include the processing tasks.
# The 'current_org' variable is available inside process_organization.yml.
- name: Process sync plans for each organization
  ansible.builtin.include_tasks: process_organization.yml
  loop: "{{ organizations_to_process }}"
  loop_control:
    loop_var: current_org
    label: "{{ current_org.name }}"

# -----------------------------------------------------------------------------
# Generate Compliance Report
# -----------------------------------------------------------------------------
- name: Display compliance report header
  ansible.builtin.debug:
    msg: |

      ============================================================
      Weekly Sync Plan Interval Compliance Report
      ============================================================

- name: Display corrected organizations
  ansible.builtin.debug:
    msg: |
      Corrected Organizations (interval changed to weekly):
      {% if corrected_organizations | length > 0 %}
      {% for org in corrected_organizations %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display compliant organizations
  ansible.builtin.debug:
    msg: |
      Compliant Organizations (no changes required):
      {% if compliant_organizations | length > 0 %}
      {% for org in compliant_organizations %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display opted-out organizations
  ansible.builtin.debug:
    msg: |
      Opted-Out Organizations (skipped):
      {% if sync_plan_enforcement_org_opt_out | length > 0 %}
      {% for org in sync_plan_enforcement_org_opt_out %}
        - {{ org }}
      {% endfor %}
      {% else %}
        (none)
      {% endif %}

- name: Display enforcement details
  ansible.builtin.debug:
    msg: |

      Enforcement Details:
      {% if enforcement_details | length > 0 %}
      {% for detail in enforcement_details %}
        - Org: {{ detail.organization }}, Plan: {{ detail.sync_plan }}, Was: {{ detail.old_interval }}, Now: weekly
      {% endfor %}
      {% else %}
        No changes were made.
      {% endif %}

      ============================================================
      End of Report
      ============================================================
